function [allp,chod,bawanv_act_chodbytrl,itrlcorr] = noveltyMDPfloats(Qe,Qf,cho,tsn,picid,qsa,rew)

options = optimset('MaxFunEvals', 10000, 'TolFun', 0.00001,'MaxIter',10000);

np = 3;
allp = nan(10,np+2);

for m = 1:20,

    params = randn(1,2);
    [mparams, lla, ef] = fminsearch(@(params) fitnoveltymdp(params,Qe,Qf,cho,tsn),params, options);
    mparams(3) = -999;
    allp(m,:) = [mparams lla ef];
    
end;

disp(allp(:,1:5));

apu = allp(:,np+2)==1;
if sum(apu)>0,
    allpu = sortrows(allp(apu,:),[np+1]);
    allp = [allpu(1,:) mean(allpu(:,np+1)==min(allpu(:,np+1)))];
else
    allp = ones(1,6)*-999;
end;

[chod] = evalfit(allp(1,1:3),Qe,Qf,cho);

for t = 1:max(size(chod,1)),
    chosel(t,1) = min(find(chod(t,:)==max(chod(t,:))));
end;
    
[ba_wa_nov_tskobj] = novelty_choice_reclassify(cho,picid,qsa,rew);

for t = 1:size(chod,1),
    tmpcho = cho;
    for r = 1:3,
        if ba_wa_nov_tskobj(t,r)>0, 
            bawanv_chod(t,r) = chod(t,ba_wa_nov_tskobj(t,r)); bawanv_actcho(t,r) = (tmpcho(t,1)==ba_wa_nov_tskobj(t,r))+0; 
        else
            bawanv_chod(t,r) = NaN; bawanv_actcho(t,r) = NaN;
        end;
    end;
end;

for t = 0:20,
    k = tsn==t;
    bawanv_chodbytrl(t+1,:) = nanmean(bawanv_chod(k,:)); 
    bawanv_actchobytrl(t+1,:) = nanmean(bawanv_actcho(k,:)); 
end;

close all;
plot(bawanv_actchobytrl)
hold on;
set(gca,'ColorOrderIndex',1);
plot(bawanv_chodbytrl,'LineWidth',2);
bawanv_act_chodbytrl = cat(3,bawanv_chodbytrl,bawanv_actchobytrl);
itrlcorr = corr(reshape(bawanv_chodbytrl(~isnan(bawanv_chodbytrl(:,1)),:),numel(bawanv_chodbytrl(~isnan(bawanv_chodbytrl(:,1)),:)),1),reshape(bawanv_actchobytrl(~isnan(bawanv_chodbytrl(:,1)),:),numel(bawanv_actchobytrl(~isnan(bawanv_chodbytrl(:,1)),:)),1));
figure();
plot(reshape(bawanv_chodbytrl(~isnan(bawanv_chodbytrl(:,1)),:),numel(bawanv_chodbytrl(~isnan(bawanv_chodbytrl(:,1)),:)),1),reshape(bawanv_actchobytrl(~isnan(bawanv_chodbytrl(:,1)),:),numel(bawanv_actchobytrl(~isnan(bawanv_chodbytrl(:,1)),:)),1),'ro');
pause(1); set(gca,'XLim',[0 1],'YLim',[0 1]);
vt = ~isnan(bawanv_actchobytrl(:,1));

% disp(diag((corr(bawanv_actchobytrl(vt,:),bawanv_chodbytrl(vt,:)))));


% for t = 1:size(chod,1)
% 
%     for r = 1:3,
%         if ba_wa_nov_tskobj(t,r)>0,
%             bawanov_d(t,r) = chod(t,ba_wa_nov_tskobj(t,r));
%         else
%             bawanov_d(t,r) = NaN;
%         end;
%     end;
%     
% end;
% 
% for r = 1:3
% 
%     for t = 0:21,
%     
%         k = tsn==t;
%         
%         bawapred(t+1,r) = nanmean(bawanov_d(k,r));
%         bawasoftmax(t+1,r) = nanmean(chosel(k,1)==ba_wa_nov_tskobj(k,r));
%         bawaact(t+1,r) = nanmean(cho(k,1)==ba_wa_nov_tskobj(k,r));
%     end;
%     
% end;
% 
% subplot(1,2,1);
% plot([0:19],bawaact(1:20,:));
% hold on; set(gca,'ColorOrderIndex',1);
% plot([0:19],bawapred(1:20,:),'LineWidth',2);
% hold on; set(gca,'ColorOrderIndex',1);
% plot([0:19],bawasoftmax(1:20,:),'LineWidth',3);
% title(num2str((corr(cat(1,bawapred(1:20,1),bawapred(1:20,2),bawapred(1:20,3)),cat(1,bawaact(1:20,1),bawaact(1:20,2),bawaact(1:20,3))))));
% 
% bawacorr = [corr(cat(1,bawapred(1:20,1),bawapred(1:20,2),bawapred(1:20,3)),cat(1,bawaact(1:20,1),bawaact(1:20,2),bawaact(1:20,3)))];
% 
% subplot(1,2,2);
% 
% % chonov = cho==ba_wa_nov_tskobj(:,3);
% % chonovmod = chosel==ba_wa_nov_tskobj(:,3);
% % 
% % for r = 1:3
% % 
% %     for t = 0:21,
% % 
% %         k = (tsn==t) & (ievcat==r);
% %         novrewpred(t+1,r) = nanmean(bawanov_d(k,3));
% %         
% %         kk = (tsn==t) & (ievcat==r);
% %         novrewact(t+1,r) = nanmean(chonov(kk,1));
% %         novrewsoftmax(t+1,r) = nanmean(chonovmod(kk,1)); 
% %     end;
% %     
% % end;
% % 
% % plot([0:19],novrewpred(1:20,:));
% % hold on; set(gca,'ColorOrderIndex',1);
% % plot([0:19],novrewact(1:20,:),'LineWidth',2);
% % hold on; set(gca,'ColorOrderIndex',1);
% % plot([0:19],novrewsoftmax(1:20,:),'LineWidth',3);
% % 
% % aa = cat(1,novrewact(1:20,1),novrewact(1:20,2),novrewact(1:20,3));
% % bb = cat(1,novrewpred(1:20,1),novrewpred(1:20,2),novrewpred(1:20,3));
% % vv = ~isnan(aa) & ~isnan(bb);
% % 
% % title(num2str(corr(bb(vv),aa(vv))));
% % novrewpredcorr = [num2str(corr(bb(vv),aa(vv)))];
% 
% pause(1);
% 
% bawapreadact = cat(3,bawapred,bawaact,bawasoftmax);
% novrewpredact = cat(3,novrewpred,novrewact,novrewsoftmax);


    
function [ll] = fitnoveltymdp(params,Qe,Qf,cho,tsn)

Qe = (Qe - 0.5)/std(reshape(Qe,numel(Qe),1));
Qf = Qf/std(reshape(Qf,numel(Qf),1));

%Qe = (Qe - .5)./(sqrt((1/12)*(0.99999-(1-0.99999))^2));
%Qf = (Qf-mean(reshape(Qf,numel(Qf),1)))./(std(reshape(Qf,numel(Qf),1)));



ll = 0;

ievbeta = params(1,1);
fevbeta = params(1,2);
beta = 1; %params(1,3);

%Qtb = Qf*fevbeta;
%Qb_mc = Qtb-repmat(mean(Qtb,2),1,3);


for t = 1:size(cho,1)
    
    v = (Qe(t,:)*ievbeta)+(Qf(t,:)*fevbeta); %Qb_mc(t,:); %
    

    d = (exp(beta*v))./(sum(exp(beta*v)));
    
    if beta>=0 && tsn(t)<=100
        ll = ll-log(d(cho(t)));
    elseif beta<0
        ll = ll-log(d(cho(t)))+(abs(beta)*10000);
    end;
%     
%     viev = (Qe(t,:)*ievbeta); vfev = (Qf(t,:)*fevbeta); %Qb_mc(t,:); %
%     
%     diev = (exp(beta*viev))./(sum(exp(beta*viev)));
%     dfev = (exp(beta*vfev))./(sum(exp(beta*vfev)));
%     
%     ll = ll-(log(diev(cho(t)))+log(dfev(cho(t))));
%     
%     if tsn(t,1)<=10000
%         
%     end;

end;

function [chod] = evalfit(params,Qe,Qf,cho)

Qe = (Qe - 0.5)/std(reshape(Qe,numel(Qe),1));
Qf = Qf/std(reshape(Qf,numel(Qf),1));

%Qe = (Qe - .5)./(sqrt((1/12)*(0.99999-(1-0.99999))^2));
%Qf = (Qf-mean(reshape(Qf,numel(Qf),1)))./(std(reshape(Qf,numel(Qf),1)));

ievbeta = params(1,1);
fevbeta = params(1,2);
beta = 1; %params(1,3);

% Qtb = Qf*fevbeta;
% Qb_mc = Qtb-repmat(mean(Qtb,2),1,3);


for t = 1:size(cho,1)
    
    v = (Qe(t,:)*ievbeta)+(Qf(t,:)*fevbeta); %(Qf(t,:)*fevbeta);
    
    d = (exp(beta*v))./(sum(exp(beta*v)));
    
    chod(t,:) = d;
    
end;








