X = readtable('ACES_allsubs_BANDIT_Modeling_filtSubs.csv');

isub = unique(table2array(X(:,1)));

subjid = table2array(X(:,1));

clear picid;

rp = [2 5 8];

fid = fopen('allsubspomdpparamfit.csv','w');

allsubsparams = nan(max(size(isub,1)),15);

for s = 1:max(size(isub,1))
    
    clear picid; 
    
    k = subjid==isub(s);
    tmptbl = X(k,:);

    imgidentcols = [4 6 8 11];
    imgprobcol = [5 7 9];

    for ti = 1:4,
        tmpimg = table2cell(tmptbl(:,imgidentcols(ti)));
        %disp(tmpimg);
        for c = 1:size(tmpimg,1)
            if isempty(strmatch('NA',tmpimg{c})),
                tmpic = regexp(tmpimg{c},'/','split');
                tmpic = regexp(tmpic{4},'.jpg','split');
                imgid(c,ti) = str2num(tmpic{1}); 
                clear tmpic;
            else
                imgid(c,ti) = NaN;
            end;
        end;
        clear tmpimg;
    end;
    
    uimgid = unique(imgid);
    

    picid = cat(1, [1 1 1],imgid(1:end-1,1:3)~=imgid(2:end,1:3));
    choprob = table2array(tmptbl(:,[5 7 9]));
    clear stimid;
    clear cho;
    for n = 1:size(picid,1)
        if ~isnan(imgid(n,4))
            cho(n,1) = find(imgid(n,1:3)==imgid(n,4));
            stimid(n,1) = find(uimgid==imgid(n,cho(n,1)));
            choprob(n,1) = choprob(n,cho(n,1));
        else
            stimid(n,1) = NaN;
            choprob(n,1:3) = NaN;
            cho(n,1)=NaN;
        end;

    end;
    
    clear ievresid;
    clear ievrel;
    clear ievcatall;
    clear ievcat_c*;
    uchoprob = unique(choprob);
    ievcatall = choprob;
    ievcatall(ievcatall==(uchoprob(1)) ) = 1;
    ievcatall(ievcatall==(uchoprob(2)) ) = 2;
    ievcatall(ievcatall==(uchoprob(3)) ) = 3;
    
    for n = 1:size(cho,1)
        if ~isnan(cho(n))
            ievcat_c(n,1) = ievcatall(n,cho(n,1));
        else
            ievcat_c(n,1) = NaN;
        end
    end;
    ievcat_c(:,2) = ievcat_c(:,1);
    ievcat_c(ievcat_c(:,2)==2,2) = 0.5;
    ievcat_c(ievcat_c(:,2)==1,2) = 0.2;
    ievcat_c(ievcat_c(:,2)==3,2) = 0.8;
    

    rew = table2array(tmptbl(:,13));
    reward = zeros(size(picid,1),1);
    reward(strmatch('True',rew),1) = 1;
    if sum(reward)==0,
        reward(strmatch('TRUE',rew),1) = 1;
    end;
    
    vt = ~isnan(cho);
    
    [Qsa,Qtran] = mdpChoice_appx_ratio_v3([],[],cho(vt,1),reward(vt,1),picid(vt,:),2,0.9);
    
    Qe = Qsa-Qtran;
    Qbon = Qtran - repmat(mean(Qtran,2),1,3);
    
    vtrls = find(vt==1);
    
    clear cQ*;
    clear maxQt;
    clear ievrel;
    
    cQsa = nan(size(picid,1),1);
    cQe = nan(size(picid,1),1);
    cQt = nan(size(picid,1),1);
    cQb = nan(size(picid,1),1);
    ievrel = nan(size(picid,1),2);
    maxQt = nan(size(picid,1),1);

    
    choo = [1 2 3];

    for n = 1:sum(vt)
        
        cQsa(vtrls(n),1) = Qsa(n,cho(vtrls(n)));
        cQe(vtrls(n),1) = Qe(n,cho(vtrls(n)));
        cQt(vtrls(n),1) = Qtran(n,cho(vtrls(n)));
        cQb(vtrls(n),1) = Qbon(n,cho(vtrls(n)));
        maxQt(vtrls(n),1) = max(Qtran(n,:));
        ievrel(vtrls(n),1) = Qe(n,cho(vtrls(n))) - max(Qe(n,(choo~=cho(vtrls(n)))));
        ievrel(vtrls(n),2) = Qe(n,cho(vtrls(n))) - min(Qe(n,(choo~=cho(vtrls(n)))));    % modified column to 2, was leaving the second col as NA
        
    end;
    
    ievresid = cQe - ievcat_c(:,2);
    
   
    for h = 1:size(picid,1)
        if sum(picid(h,:))==3,
            tsn=0;
            trlsnov(h,1) = tsn;
        elseif sum(picid(h,:))==1,
            tsn = 0;
            trlsnov(h,1) = tsn;
        elseif sum(picid(h,:))==0,
            tsn = tsn+1;
            trlsnov(h,1) = tsn;
        end;
    end;
    
    [ba_wa_nov_tskobj] = novelty_choice_reclassify(cho(vt,1),picid(vt,:),Qsa,reward(vt,:));
    
    novopt = nan(size(picid,1),1);
    novopt(vt,1) = ba_wa_nov_tskobj(:,3);
    
    besopt = nan(size(picid,1),1);
    besopt(vt,1) = ba_wa_nov_tskobj(:,1);
    
    woropt = nan(size(picid,1),1);
    woropt(vt,1) = ba_wa_nov_tskobj(:,2);
    
    for np = 1:size(picid,1)
        if vt(np,1)==1 & novopt(np,1)>0
            novprob(np,1) = choprob(np,novopt(np,1));
            baltprob(np,1) = choprob(np,besopt(np,1));
        else
            novprob(np,1) = NaN;
            baltprob(np,1) = NaN;
        end;
    end;

    chosenovel = cho==novopt;
    chosebest = cho==besopt;
    choseworst = cho==woropt;
    
    for m = 1:10
        k = trlsnov==(m-1);
        cn(m,s) = nanmean(chosenovel(k,1));
        cb(m,s) = nanmean(chosebest(k,1));
        cw(m,s) = nanmean(choseworst(k,1));
    end;
    
    for m = 1:10
        for r = 1:3,
            k = novprob==rp(r) & trlsnov==(m-1);
            novlearn(m,r,s) = nanmean(chosenovel(k,1)); 
        end;
    end;
    
    tmpcon = table2cell(tmptbl(:,10));
    confidence = nan(size(picid,1),1);
    for c = 1:size(tmpcon,1)
        if isempty(strmatch('NA',tmpcon{c}))
            confidence(c,1) = str2num(tmpcon{c});
        end;
    end;
    
    
    [allp,chod,bawavn_actcho_mdpchod,icorr] = noveltyMDPfloats(Qsa-Qtran,Qbon,cho(vt,1),trlsnov(vt,1),picid(vt,:),Qsa,reward(vt,1));
    
    sublogistic{s} = cat(2,chosenovel(vt,1),cQb(vt,1),cQe(vt,1),cQt(vt,1),cQsa(vt,1),confidence(vt,1),trlsnov(vt,1),...
        Qsa-Qtran,Qbon,cho(vt,1),picid(vt,:),Qsa,reward(vt,1),chod,chosebest(vt,1),choseworst(vt,1),ievcatall(vt,:),ievcat_c(vt,1),stimid(vt,1),...
        vtrls,novopt(vt,1),novprob(vt,1));
    all_bawavn_actcho_mdpchod{s} = bawavn_actcho_mdpchod;
    cho =  sublogistic{s}(:,14);
    rew = sublogistic{s}(:,21);
    novobj =  sublogistic{s}(:,33);
    block = (rew*0)+1;
    mi = 10000;
    tsn = sublogistic{s}(:,7);
    [rlallp,chodn,chodf] = noveltyRL(cho,rew,tsn,novobj,block,mi);
    clear cho; clear novobj; clear block; clear mi; clear tsn; clear rew;
    
    allsubsparams(s,:) = cat(2,isub(s),sum(vt),allp,rlallp,icorr);
    fprintf(fid,'%g,%g,%g,%g,%g,%g,%g,%g,%g,%g,%g,%g,%g,%g,%g\n',allsubsparams(s,:));
    
    
    try
        tmpS = [repmat(isub(s),size(chosenovel,1),1),[1:size(chosenovel,1)]',chosenovel,chosebest,choseworst,trlsnov,cQb,cQe,cQt,cQsa,confidence,maxQt,novprob,ievcat_c(:,1),ievresid,ievrel,stimid];
    catch
        disp('Error');
        continue; 
    end;
    save(['subjid_revision_',num2str(isub(s)),'_mdpout.txt'],'tmpS','-ascii','-tabs');
    clear tmpS;
    
    
    
    %[ba_wa_nov_tskobj] = novelty_choice_reclassify(cho(vt,1),picid(vt,:),allQsa(vt,:),rew(vt,:));
    
    pause(1);
    
end;

fclose(fid);

save('allsubspomdpparamfit.mat','allsubsparams');
save('subsvarout.mat','sublogistic');

close all;
subplot(1,2,1);
plot(nanmean(cn(1:8,:),2))
hold on;
plot(nanmean(cb(1:8,:),2));
plot(nanmean(cw(1:8,:),2));
subplot(1,2,2);
plot(nanmean(novlearn(1:8,:,:),3));

        
    