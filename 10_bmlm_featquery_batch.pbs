#!/bin/bash
# Explore-Exploit fMRI: Neuron Manuscript
# main featquery parallization script on CARC Wheeler cluster
# uses featquery to pull % signal change for all ROIs and all contrasts of interest
# author: jeremy hogeveen (jhogeveen@unm.edu)
# last edit: March 9, 2022
#PBS -l nodes=2:ppn=8
#PBS -l walltime=48:00:00
#PBS -N featquery_batch_rhputa
#PBS -S /bin/bash
#PBS -j oe
#PBS -m bea
#PBS -M jhogeveen@unm.edu
#PBS -V

cd $PBS_O_WORKDIR

module load fsl
module load parallel-20170322-intel-18.0.2-4pa2ap6

# Modify this to cycle through which run you want to analyze, 01, 02, 03, or 04
MODEL_NAME="allruns_modelbased_wconstant"
fsl_folder=PATHPATHPATHPATH # path to fsl directory
roi_file="PATHPATHPATHPATH/10b_bmlm_featquery_roilist.txt"

JOBS_PER_NODE="1"

# This is a weird necessity for running FSL with gnu parallel and copies all environment variables to compute nodes
source `which env_parallel.bash`

# Need to use env_parallel here with FSL or it will not execute
# COPEs OF INTEREST 
declare -a cope_list=( 
	'cope1.feat'
	'cope4.feat'
	'cope7.feat'
	'cope16.feat'
) 
declare -a cope_name_list=( 
	'bonus'
	'fev'
	'iev'
	'rpe'
)

# looping through and doing the work
for ((c=0; c<${#cope_list[*]}; c++)); do
	cope=${cope_list[c]}
	cope_name=${cope_name_list[c]}
	while read line; do
		roi="$(basename -s .txt ${line})"
		featq_folder="${cope_name}_${roi}_featquery"
		env_parallel --sshloginfile $PBS_NODEFILE --jobs $JOBS_PER_NODE --workdir $PBS_O_WORKDIR -a ../subject_list.txt featquery 1 ${fsl_folder}/{}/${MODEL_NAME}.gfeat/${cope} 1 stats/cope1 $featq_folder -p -s $line
	done < $roi_file
done
