#!/usr/bin/env Rscript
# -*- coding: utf-8 -*-
# """
# Explore-Exploit fMRI: Neuron Manuscript
# Running BMLM on the listed set of contrasts

# author: jeremy hogeveen (jhogeveen@unm.edu)
# last edit: March 9, 2022
# """

# clear env
if(!is.null(dev.list())) dev.off()
rm(list = ls())
cat("\014") 
options(buildtools.check = function(action) TRUE)
ptm <- proc.time()

# packages loaded
library(brms)
library(brmstools)
library(cmdstanr)
library(tidyverse) # needed for data manipulation.
library(parallel)

contrast_list <- c('modelbasedv1_bonus','modelbasedv1_trlsnov','modelbasedv1_iev','modelbasedv1_fev','modelbasedv1_rpe') 

for (c in contrast_list) {
  
  # set contrast name i loop
  contrast_name <- c
  
  # load the data table
  # base filepath
  basefolder <- '#####' # filepath to base directory
  # input data for bandit task
  rba_datafile <- paste(basefolder,paste('data_frames/',contrast_name,'.txt',sep=''),sep='/')
  df <- read_tsv(rba_datafile)
  # results filepath
  rba_outdir <- paste(basefolder,'rba_results',sep='/')
  rba_outplot <- paste(rba_outdir,paste(contrast_name,'_bysubj.pdf',sep=''),sep='/')
  rba_outfile <- paste(rba_outdir,paste(contrast_name,'.RData',sep=''),sep='/')

  # setting stan
  iterations <- 20000 # 10000 for most models, upped to 20000 for IEV cause it had convergence issue
  chains <- 4
  SCALE <- 1
  df$ROI <- factor(df$ROI)
  df$Subj<- factor(df$Subj)

  # gettin ginformation about the # ROIs and COPU cores
  print(paste0('Number of ROI: ',nlevels(df$ROI)))
  print(paste0('Number of cores available: ', detectCores(all.tests = FALSE, logical = TRUE)))
  cores_to_parallel <-  detectCores(all.tests = FALSE, logical = TRUE) * 0.75

  # Set nuber of cores to use.
  options(mc.cores = parallel::detectCores())

  # setting up the model
  modelForm <- as.formula(paste('Y|se(SE, sigma = TRUE) ~ 1 + (1|gr(Subj, dist=\'student\')) + (1|gr(ROI, dist=\'student\'))'))
  
  # running BMLM analysis
  run_brm <- brm(modelForm, data=df, chains = chains, family='student', inits=0,
                  iter=iterations, control = list(adapt_delta = 0.99, max_treedepth = 15),
                  backend = "cmdstanr", threads = threading(cores_to_parallel))

  # Save the results as a RData file
  save.image(rba_outfile)
}

proc.time() - ptm
