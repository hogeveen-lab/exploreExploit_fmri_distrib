#!/usr/bin/env Rscript
# -*- coding: utf-8 -*-
# """
# Explore-Exploit fMRI: Neuron Manuscript
# Generating tables summarizing the BMLM model results

# author: jeremy hogeveen (jhogeveen@unm.edu)
# last edit: March 9, 2022
# """

#### #### #### #### ####
# Chunk #1: PREAMBLE #
#### #### #### #### ####
# * setting paths
# * loading R packages
# * creating some homemade plotting etc. functions

# clear env
if(!is.null(dev.list())) dev.off()
rm(list = ls())
cat("\014") 
options(buildtools.check = function(action) TRUE)

### Paths
# base filepath
basefolder <- '#####' # filepath to base directory
# input data for bandit task
rba_data <- paste(basefolder,'data_frames',sep='/')
rba_results <- paste(basefolder,'rba_results',sep='/')

### Loading some functions
source(paste(basefolder,'bandit_functions.R',sep='/'))

### Reading in the packages I tend to use
source(paste(basefolder,'bandit_packages.R',sep='/'))
mylib()


### Setting some misc options
# Custom palette for plotting
my_palette <- c("#0000FF","#3ADF00","#FF0000","#ff7f00","#6a3d9a",
                "#a6cee3","#b2df8a","#fb9a99","#fdbf6f","#cab2d6",
                "#8dd3c7","#bebada","#d9d9d9","#fccde5","#ffffb3")
# Position dodging for interaction plots:
dodge <- position_dodge(1)
# For changing the default font sizes for all plots:
size<-11
theme_set(theme_grey(base_size = size))
# other miscellaneous stuff
select <- dplyr::select # to avoid lme4 overwriting select for dplyr
options(scipen = 999) # to provide precise decimal places rather than exponential notation

# overlapping / unique ROIs for ridgeline plots
exploreExploit_ROIs <- c('Amygdala','Accumbens','Caudate','Putamen','IFSa_ROI','p9-46v_ROI','p10p_ROI','10v_ROI','OFC_ROI','s32_ROI','a32pr_ROI','LIPd_ROI','31pd_ROI','FFC_ROI','TE1a_ROI')


#### #### #### #### ####
# Chunk #2: BMLM results #
#### #### #### #### ####
# generating summary tables of the posteriors from the BMLM models

# Listing all bmlm models
contrast_list <- c('bonus','trlsnov','iev','fev','rpe') 

# Looping through maskave files
for(i in 1:length(contrast_list)){
  
  ### RIDGELINE    
  curbmlm_file <- list.files(rba_results,pattern=paste(contrast,'RData',sep='.'))
  curbmlm_RData <- paste(rba_results,curbmlm_file,sep='/')
  
  # loading the RData file
  load(curbmlm_RData)
  # Extract posteriors for fixed (aa) and random effects (bb)
  aa <- fixef(run_brm, summary = FALSE)/SCALE # Population-Level Estimates
  bb <- lapply(ranef(run_brm, summary = FALSE), `/`, SCALE) # Extract Group-Level (or random-effect)
  # Sum the fixed and random effect (only ROI) posterior. Following function does this.
  # The function adds the "the poaterior of the global intercept (or slope) with the 
  # intercept (or slope) posterior of each roi. bb[['ROI']][,,tm] is a matrix with 
  # columns containing posteriors for every ROI
  # aa[,tm] is a single column posterior for the global intercept/slope.
  # intercept or slope is defined by tm, where tm is the index of the model term.
  psROI <- function(aa, bb, tm) {
    ps <- apply(bb[['ROI']][,,tm], 2, '+', aa[,tm])
    return(ps)
  }
  # saves full posterior for each ROI
  posteriors <- psROI(aa, bb, 1)
  posteriors <- as_data_frame(posteriors) %>% 
    select(ends_with('_ROI') | contains('harvard'))
  write.table(posteriors,paste(rba_results,paste0(contrast,'_post.txt'),sep='/'),sep='\t',
              col.names = TRUE, row.names = FALSE)
  
  # reading the full posterior then making it a bit more manageable
  rois <- colnames(posteriors)
  df <- read.table(here(paste(rba_results,paste0(contrast,'_post.txt'),sep='/')), sep = "", header = T)
  df$X <- NULL
  colnames(df) <- rois
  iterations <- length(df[,1])
  df_long <- df %>% gather(ROI)
  colnames(df_long) <- c("ROI", "Y")
  df_long <- df_long %>%
    mutate(index = rep(1:length(rois), each = iterations)) %>%
    group_by(ROI) %>%
    mutate(mean = mean(Y),low_hdi = quantile(Y, c(0.1)), high_hdi = quantile(Y, c(0.9))) %>%
    mutate(p = ((sum(Y>0)/iterations))) %>%
    mutate(p_plot = p) %>%
    mutate(p_plot = replace(p_plot, p_plot > 0.15 & p_plot < 0.85, NA))
  
  # saving summary of posterior sample results
  df_long_summary <- df_long %>%
    select(ROI,mean,low_hdi,high_hdi,p,p_plot) %>%
    distinct()
  write.csv(df_long_summary,paste(rba_results,paste0(contrast,'HCPMMP1_Pplus.csv'),sep='/'),row.names = FALSE)
  
  # reading in the glasser atlas labels, saving posterior summary strictly for the cortex
  glasserLabels = read_tsv(paste(basefolder,'rois/glasser/HumanCorticalParcellations_wN_6V6gD/Q1-Q6_RelatedParcellation210.L.CorticalAreas_dil_Black.32k_fs_LR_labelorder.txt',sep='/'),col_names = c('INDEX','ROI'))
  df_long_summary_cort <- df_long_summary %>%
    filter(!grepl("harvardoxford",ROI)) %>%
    merge(glasserLabels,by='ROI') %>%
    arrange(INDEX) %>%
    ungroup() %>%
    select(p)
  write.table(df_long_summary_cort,paste(rba_results,paste0(contrast,'HCPMMP1_Pplus_cortex.txt'),sep='/'),row.names = FALSE,col.names = FALSE)
  
  # saving posterior summary strictly for the subcortex
  df_long_summary_subcort <- df_long_summary %>%
    filter(grepl("harvardoxford",ROI)) %>%
    arrange(ROI) %>%
    ungroup() %>%
    select(p)
  write.table(df_long_summary_subcort,paste(rba_results,paste0(contrast,'HCPMMP1_Pplus_subcortex.txt'),sep='/'),row.names = FALSE,col.names = FALSE)
  
  # summary dataframe for P+ labels
  df_long_filt <- df_long %>% filter(grepl(paste(exploreExploit_ROIs, collapse = "|"),ROI)) %>%
    filter(!grepl("pOFC",ROI)) %>%
    mutate(ROI=str_replace(ROI,'reslice_thr_harvardoxford-subcortical_prob_',''))
  P <- df_long_filt %>%
    select(ROI, index, mean, p)  %>%
    unique() %>%
    arrange(mean)
  
  # printed summary
  df_sum <- df_long_filt %>% group_by(ROI) %>% 
    mutate(ROI=str_replace(ROI,'reslice_thr_harvardoxford-subcortical_prob_',''),
           p = sum(Y>0)/iterations,
           perc_025=quantile(Y, 0.025),
           perc_05=quantile(Y, 0.05),
           perc_50=quantile(Y, 0.5),
           perc_95=quantile(Y, 0.95),
           perc_975=quantile(Y, 0.975)) %>%
    select(-Y,index) %>%
    distinct() %>%
    arrange(mean)
  write.table(df_sum,paste(rba_results,paste0(contrast,'_filtsum.txt'),sep='/'),sep='\t',
              col.names = TRUE, row.names = FALSE)
}

