#!/usr/bin/env Rscript
# -*- coding: utf-8 -*-
# '''
# Explore-Exploit fMRI: Neuron Manuscript
# Generating ridgeline plots of ROI-filtered cortical and subcortical BMLM results

# author: jeremy hogeveen (jhogeveen@unm.edu)
# last edit: March 9, 2022
# '''

#### #### #### #### ####
#### #### #### #### #### Chunk #1: PREAMBLE #### #### #### #### ####
#### #### #### #### ####
# * setting paths
# * loading R packages
# * creating some homemade plotting etc. functions

# clear env
if(!is.null(dev.list())) dev.off()
rm(list = ls())
cat("\014") 
options(buildtools.check = function(action) TRUE)

### Paths
# base filepath
basefolder <- '#####' # filepath to base directory
# input data for bandit task
rba_data <- paste(basefolder,'data_frames',sep='/')
rba_results <- paste(basefolder,'rba_results',sep='/')
# set up a potential output folder for saving plots
plotsfolder <- paste(basefolder,'rba_plots',sep = '/')

### Loading some functions
source(paste(basefolder,'bandit_functions.R',sep='/'))

### Reading in the packages I tend to use
source(paste(basefolder,'bandit_packages.R',sep='/'))
mylib()


### Setting some misc options
# Custom palette for plotting
my_palette <- c('#0000FF','#3ADF00','#abd9e9','#abdda4')
# Position dodging for interaction plots:
dodge <- position_dodge(1)
# For changing the default font sizes for all plots:
size<-11
theme_set(theme_grey(base_size = size))
# other miscellaneous stuff
select <- dplyr::select # to avoid lme4 overwriting select for dplyr
options(scipen = 999) # to provide precise decimal places rather than exponential notation

# overlapping / unique ROIs for ridgeline plots
exploreExploit_cortROIs <- c('p10p','p9-46v','IFSp','LIPd','a32pr','s32','10v','OFC')
exploreExploit_subcortROIs <- c('Amygdala','Accumbens','Caudate','Putamen')

# Sum the fixed and random effect (only ROI) posterior. Following function does this.
# The function adds the 'the poaterior of the global intercept (or slope) with the 
# intercept (or slope) posterior of each roi. bb[['ROI']][,,tm] is a matrix with 
# columns containing posteriors for every ROI
# aa[,tm] is a single column posterior for the global intercept/slope.
# intercept or slope is defined by tm, where tm is the index of the model term.
psROI <- function(aa, bb, tm) {
  ps <- apply(bb[['ROI']][,,tm], 2, '+', aa[,tm])
  return(ps)
}

#### #### #### #### ####
#### #### #### #### #### Chunk #2: subcortical ridgeline of RBA results BONUS #### #### #### #### ####
#### #### #### #### ####
# reading in the BRMS results
bonus_bmlm <- list.files(rba_results, pattern='bonus.RData')
load(paste(rba_results,bonus_bmlm,sep='/'))
# Extract posteriors for fixed (aa) and random effects (bb)
bonus_aa <- fixef(run_brm, summary = FALSE)/SCALE # Population-Level Estimates
bonus_bb <- lapply(ranef(run_brm, summary = FALSE), `/`, SCALE) # Extract Group-Level (or random-effect)
# saves all posterior samples by ROI
bonus_posteriors <- psROI(bonus_aa, bonus_bb, 1)
write.table(bonus_posteriors,paste(rba_results,paste0('bonus','_post.txt'),sep='/'),sep='\t',col.names = TRUE, row.names = FALSE)
# coding some homemade ridgeline plots
bonus_rois <- colnames(bonus_posteriors)
bonus_df <- read.table(here(paste(rba_results,paste0('bonus','_post.txt'),sep='/')), sep = '', header = T)
bonus_df$X <- NULL
colnames(bonus_df) <- bonus_rois
iterations <- length(bonus_df[,1])
bonus_df_long <- bonus_df %>% gather(ROI)
colnames(bonus_df_long) <- c('ROI', 'Y')
bonus_df_long <- bonus_df_long %>%
  mutate(index = rep(1:length(bonus_rois), each = iterations)) %>%
  group_by(ROI) %>%
  mutate(mean = mean(Y),se = sd(Y)/sqrt(iterations)) %>%
  mutate(p = ((sum(Y>0)/iterations))) %>%
  mutate(p_plot = p) %>%
  mutate(p_plot = replace(p_plot, p_plot > 0.15 & p_plot < 0.85, NA))
# summary dataframe for P+ labels
bonus_df_long_filt <- bonus_df_long %>% filter(grepl(paste(exploreExploit_subcortROIs, collapse = '|'),ROI)) %>%
  mutate(ROI=str_replace(ROI,'reslice_thr_harvardoxford-subcortical_prob_',''))
bonus_P <- bonus_df_long_filt %>%
  select(ROI, index, mean, p)  %>%
  unique()

#### #### #### #### ####
#### #### #### #### #### Chunk #3: subcortical ridgeline of RBA results IEV #### #### #### #### ####
#### #### #### #### ####
iev_bmlm <- list.files(rba_results, pattern='_iev.RData')
load(paste(rba_results,iev_bmlm,sep='/'))
# Extract posteriors for fixed (aa) and random effects (bb)
iev_aa <- fixef(run_brm, summary = FALSE)/SCALE # Population-Level Estimates
iev_bb <- lapply(ranef(run_brm, summary = FALSE), `/`, SCALE) # Extract Group-Level (or random-effect)
# saves all posterior samples by ROI
iev_posteriors <- psROI(iev_aa, iev_bb, 1)
write.table(iev_posteriors,paste(rba_results,paste0('iev','_post.txt'),sep='/'),sep='\t',col.names = TRUE, row.names = FALSE)
# coding some homemade ridgeline plots
iev_rois <- colnames(iev_posteriors)
iev_df <- read.table(here(paste(rba_results,paste0('iev','_post.txt'),sep='/')), sep = '', header = T)
iev_df$X <- NULL
colnames(iev_df) <- iev_rois
iterations <- length(iev_df[,1])
iev_df_long <- iev_df %>% gather(ROI)
colnames(iev_df_long) <- c('ROI', 'Y')
iev_df_long <- iev_df_long %>%
  mutate(index = rep(1:length(iev_rois), each = iterations)) %>%
  group_by(ROI) %>%
  mutate(mean = mean(Y),se = sd(Y)/sqrt(iterations)) %>%
  mutate(p = ((sum(Y>0)/iterations))) %>%
  mutate(p_plot = p) %>%
  mutate(p_plot = replace(p_plot, p_plot > 0.15 & p_plot < 0.85, NA))
# summary dataframe for P+ labels
iev_df_long_filt <- iev_df_long %>% filter(grepl(paste(exploreExploit_subcortROIs, collapse = '|'),ROI)) %>%
  mutate(ROI=str_replace(ROI,'reslice_thr_harvardoxford-subcortical_prob_',''))
iev_P <- iev_df_long_filt %>%
  select(ROI, index, mean, p)  %>%
  unique()

#### #### #### #### ####
#### #### #### #### #### Chunk #4: merging subcortical DF's and generating the first ridgeline #### #### #### #### ####
#### #### #### #### ####

# merging the long data frames
bonus_df_long_filt <- bonus_df_long_filt %>% mutate(Condition='bonus')
iev_df_long_filt <- iev_df_long_filt %>% mutate(Condition='iev')
alldf_long_filt <- rbind(bonus_df_long_filt,iev_df_long_filt) 
alldf_long_filt <- alldf_long_filt %>% 
  mutate(anat_ROI=substring(ROI, regexpr('_', ROI) + 1, nchar(ROI))) %>%
  mutate(anat_ROI = factor(anat_ROI, levels=c('Amygdala', 'Accumbens', 'Putamen', 'Caudate'))) %>%
  mutate(hem=sub("_.*", "", ROI)) %>%
  unite("cond_hem",Condition,hem,remove=F) %>%
  mutate(cond_hem = factor(cond_hem, levels=c('bonus_Left', 'bonus_Right', 'iev_Left', 'iev_Right')))
#plotting the LH ridgeline
pdf(file=paste(plotsfolder,'bmlm_subcort_ridgeline_plot_se.pdf',sep='/'))
ggplot(alldf_long_filt, aes(x = Y, y = anat_ROI, color = cond_hem, point_color = cond_hem, fill = cond_hem)) +
  geom_density_ridges(alpha=0.8,
                      jittered_points = TRUE, 
                      scale = .95, 
                      rel_min_height = .01,
                      point_shape = '|', 
                      point_size = 3, 
                      size = 0.25,
                      position = position_points_jitter(height = 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0), name = 'BOLD (%sig.)') +
  scale_fill_manual(values = c(my_palette[1],my_palette[3], my_palette[2], my_palette[4]), labels = c('BONUS-LH','BONUS-RH', 'IEV-LH', 'IEV-RH')) +
  scale_color_manual(values = c(my_palette[1],my_palette[3], my_palette[2], my_palette[4]), guide = 'none') +
  scale_discrete_manual('point_color', values = c(my_palette[1],my_palette[3], my_palette[2], my_palette[4]), guide = 'none') +
  coord_cartesian(clip = 'off') +
  guides(fill = guide_legend(override.aes = list(fill = c(my_palette[1],my_palette[3], my_palette[2], my_palette[4]),color = NA, point_color = NA))) +
  ggtitle('Subcortical Encoding of POMDP Parameters') +
  ylab('Anatomical ROI (bilateral)') +
  theme_ridges(center = TRUE) +
  geom_vline(xintercept = 0, alpha = .85, color = 'black', size = .8)
dev.off()

#### #### #### #### ####
#### #### #### #### #### Chunk #5: cortical ridgeline of RBA results BONUS #### #### #### #### ####
#### #### #### #### ####
# summary dataframe for P+ labels
bonus_cort_df_long_filt <- bonus_df_long %>% filter(grepl(paste(exploreExploit_cortROIs, collapse = '|'),ROI))
bonus_cort_P <- bonus_cort_df_long_filt %>%
  select(ROI, index, mean, p)  %>%
  unique()

#### #### #### #### ####
#### #### #### #### #### Chunk #6: subcortical ridgeline of RBA results iev #### #### #### #### ####
#### #### #### #### ####
# summary dataframe for P+ labels
iev_cort_df_long_filt <- iev_df_long %>% filter(grepl(paste(exploreExploit_cortROIs, collapse = '|'),ROI))
iev_cort_P <- iev_cort_df_long_filt %>%
  select(ROI, index, mean, p)  %>%
  unique()

# merging the long data frames
bonus_cort_df_long_filt <- bonus_cort_df_long_filt %>% mutate(Condition='bonus')
iev_cort_df_long_filt <- iev_cort_df_long_filt %>% mutate(Condition='iev')
alldf_cort_long_filt <- rbind(bonus_cort_df_long_filt,iev_cort_df_long_filt)
alldf_cort_long_filt <- alldf_cort_long_filt %>%
  mutate(ROI=str_replace(ROI,'_ROI','')) %>%
  mutate(anat_ROI=substring(ROI, regexpr('_', ROI) + 1, nchar(ROI))) %>%
  filter(!grepl('pOFC',ROI)) %>%
  mutate(anat_ROI = ifelse(anat_ROI=='p10p','lFPC',
                           ifelse(anat_ROI=='10v','mFPC',
                                  ifelse(anat_ROI=='p9-46v','dlPFC',
                                         ifelse(anat_ROI=='IFSp','vlPFC',
                                                ifelse(anat_ROI=='a32pr','dACC',
                                                       ifelse(anat_ROI=='s32','sgACC',anat_ROI))))))) %>%
  mutate(anat_ROI = factor(anat_ROI, levels=c('LIPd','vlPFC','dlPFC','dACC','sgACC','OFC','mFPC','lFPC'))) %>%
  mutate(hem=sub("_.*", "", ROI)) %>%
  unite("cond_hem",Condition,hem,remove=F) %>%
  mutate(cond_hem = factor(cond_hem, levels=c('bonus_LH', 'bonus_RH', 'iev_LH', 'iev_RH')))

#### #### #### #### ####
#### #### #### #### #### Chunk #7: merging cortical DF's and generating the second ridgeline #### #### #### #### ####
#### #### #### #### ####

#plotting the ridgelines
pdf(file=paste(plotsfolder,'bmlm_cort_ridgeline_plot_se.pdf',sep='/'))
ggplot(alldf_cort_long_filt, aes(x = Y, y = anat_ROI,  color = cond_hem, point_color = cond_hem, fill = cond_hem)) +
  geom_density_ridges(alpha=0.8,
                      jittered_points = TRUE,
                      scale = .95,
                      rel_min_height = .01,
                      point_shape = '|',
                      point_size = 3,
                      size = 0.25,
                      position = position_points_jitter(height = 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0), name = 'BOLD (%sig.)') +
  scale_fill_manual(values = c(my_palette[1],my_palette[3], my_palette[2], my_palette[4]), labels = c('BONUS-LH','BONUS-RH', 'IEV-LH', 'IEV-RH')) +
  scale_color_manual(values = c(my_palette[1],my_palette[3], my_palette[2], my_palette[4]), guide = 'none') +
  scale_discrete_manual('point_color', values = c(my_palette[1],my_palette[3], my_palette[2], my_palette[4]), guide = 'none') +
  coord_cartesian(clip = 'off') +
  guides(fill = guide_legend(override.aes = list(fill = c(my_palette[1],my_palette[3], my_palette[2], my_palette[4]),color = NA, point_color = NA))) +
  ggtitle('Cortical Encoding of POMDP Parameters') +
  ylab('Anatomical ROI (bilateral)') +
  theme_ridges(center = TRUE) +
  geom_vline(xintercept = 0, alpha = .85, color = 'black', size = .8)
dev.off()