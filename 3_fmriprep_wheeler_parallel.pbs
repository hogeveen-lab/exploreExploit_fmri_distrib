#!/bin/bash
# Explore-Exploit fMRI: Neuron Manuscript
# main fmriprep parallization script on CARC Wheeler cluster
# fmriprep version 20.2
# author: jeremy hogeveen (jhogeveen@unm.edu)
# last edit: March 9, 2022
#PBS -l nodes=15:ppn=8
#PBS -l walltime=48:00:00
#PBS -N fmriprep_multinode
#PBS -S /bin/bash
#PBS -j oe
#PBS -m bea
#PBS -M jhogeveen@unm.edu
#PBS -V

fmriprep_folder=/home/fmriprep

module load singularity
module load parallel

ls $PBS_O_WORKDIR/bids/ | grep sub- | parallel --workdir $PBS_O_WORKDIR -j 1 --joblog bandit.log --sshloginfile $PBS_NODEFILE --env PATH singularity run --cleanenv -B $PBS_O_WORKDIR:$fmriprep_folder $PBS_O_WORKDIR/fmriprep-20.2.simg $fmriprep_folder/bids $fmriprep_folder/fmriprep participant -w $fmriprep_folder/fmriprep_work --use-syn-sdc --ignore fieldmaps --fs-license-file $HOME/license.txt --resource-monitor --verbose --nthreads 8 --omp-nthreads 8 --participant-label {}
